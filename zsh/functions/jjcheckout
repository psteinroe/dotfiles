# jj workspace helper - checkout a branch or PR into a workspace
# Usage: jjcheckout <branch-name|pr-number>
if [ -z "$1" ]; then
  echo "Usage: jjcheckout <branch-name|pr-number>"
  echo "Creates a workspace for a remote branch or PR"
  return 1
fi

local input="$1"
local branch_name=""
local workspace_name=""

# Find repo root
local repo_root=$(jj workspace root 2>/dev/null)
if [ -z "$repo_root" ]; then
  echo "Not in a jj repository"
  return 1
fi

# Check if input is a PR number (all digits)
if [[ "$input" =~ ^[0-9]+$ ]]; then
  if ! command -v gh >/dev/null 2>&1; then
    echo "GitHub CLI (gh) required for PR checkout."
    return 1
  fi
  branch_name=$(gh pr view "$input" --json headRefName -q '.headRefName' 2>/dev/null)
  if [ -z "$branch_name" ]; then
    echo "Could not find PR #$input"
    return 1
  fi
  workspace_name="pr-$input"
  echo "PR #$input: $branch_name"
else
  branch_name="$input"
  # Use branch name as workspace, replacing / with -
  workspace_name="${branch_name//\//-}"
fi

# Go to repo root
local current_dir=$(pwd)
cd "$repo_root"

echo "Fetching latest changes..."
jj git fetch --all-remotes

local workspace_path="$repo_root/$workspace_name"

# Check if workspace already exists
if [ -d "$workspace_path" ]; then
  echo "Workspace already exists at $workspace_path"
  echo "Navigating to existing workspace..."
  cd "$workspace_path"
  return 0
fi

echo "Creating workspace: $workspace_name"
if ! jj workspace add "$workspace_name" "$workspace_path"; then
  echo "Failed to create workspace"
  cd "$current_dir"
  return 1
fi

cd "$workspace_path"

echo "Tracking and checking out branch: $branch_name"
jj bookmark track "${branch_name}@origin" 2>/dev/null || true
jj edit "$branch_name"

# Install dependencies
[ -f ".gitmodules" ] && echo "Updating submodules..." && git submodule update --init --recursive
[ -f "pnpm-lock.yaml" ] && echo "Running pnpm install..." && pnpm install
[ -f "bun.lockb" ] || [ -f "bun.lock" ] && echo "Running bun install..." && bun install
[ -f "Cargo.toml" ] && (grep -q "^\[workspace\]" "Cargo.toml" || [ -d "crates" ]) && echo "Running cargo check..." && cargo check

echo "\nChecked out $branch_name at: $(pwd)"
