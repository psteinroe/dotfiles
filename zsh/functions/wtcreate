# Git worktree helper - creates a new worktree and navigates to it
# Usage: wtcreate <branch-name>
if [ -z "$1" ]; then
  echo "Usage: wtcreate <branch-name>"
  return 1
fi

local branch_name="$1"
local repo_root=$(git worktree list --porcelain | grep "^worktree" | head -1 | cut -d' ' -f2-)

if [ -z "$repo_root" ]; then
  echo "Not in a git repository"
  return 1
fi

echo "Fetching latest changes..."
git fetch

local main=$(gh repo view --json defaultBranchRef -q '.defaultBranchRef.name' 2>/dev/null || echo "main")
local repo_name=$(basename "$repo_root")
local worktree_parent=$(dirname "$repo_root")

if [[ "$repo_name" == *.git ]]; then
  local worktree_path="$worktree_parent/$repo_name/$branch_name"
else
  local worktree_path="$worktree_parent/$repo_name.git/$branch_name"
fi

# Create worktree from origin/main (not local HEAD), without tracking origin/main
if git worktree add "$worktree_path" -b "$branch_name" --no-track "origin/$main"; then
  echo "Created worktree at: $worktree_path"
  cd "$worktree_path"
  wtsetup
else
  echo "Failed to create worktree"
  return 1
fi
