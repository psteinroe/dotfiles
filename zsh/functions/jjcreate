# jj workspace helper - creates a new workspace
# Usage: jjcreate <workspace-name>
if [ -z "$1" ]; then
  echo "Usage: jjcreate <workspace-name>"
  echo "Creates a jj workspace alongside existing ones"
  return 1
fi

local workspace_name="$1"

# Check we're in a jj repo
if ! jj root &>/dev/null; then
  echo "Not in a jj repository"
  return 1
fi

# Get the repo root (parent of current workspace)
local jj_root="$(jj root)"
local repo_root="$(dirname "$jj_root")"
local workspace_path="$repo_root/$workspace_name"

if [ -d "$workspace_path" ]; then
  echo "Workspace already exists at $workspace_path"
  return 1
fi

echo "Fetching latest changes..."
jj git fetch --all-remotes

echo "Creating workspace: $workspace_name"
if ! jj workspace add "$workspace_path"; then
  echo "Failed to create workspace"
  return 1
fi

cd "$workspace_path"

echo "Creating bookmark: $workspace_name"
jj bookmark create "$workspace_name" -r @

# Install dependencies
[ -f ".gitmodules" ] && echo "Updating submodules..." && git submodule update --init --recursive
[ -f "pnpm-lock.yaml" ] && echo "Running pnpm install..." && pnpm install
[ -f "bun.lockb" ] || [ -f "bun.lock" ] && echo "Running bun install..." && bun install
[ -f "Cargo.toml" ] && (grep -q "^\[workspace\]" "Cargo.toml" || [ -d "crates" ]) && echo "Running cargo check..." && cargo check

echo "\nCreated workspace at: $(pwd)"
