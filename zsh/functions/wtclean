# Git worktree helper - lists worktrees and cleans up merged PRs
git worktree list

if ! command -v gh >/dev/null 2>&1; then
  echo "\nGitHub CLI (gh) required for safe cleanup."
  return 1
fi

echo "\nChecking PR status..."
local cleanup_candidates=()
local repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
local temp_file=$(mktemp)

git worktree list --porcelain | grep '^worktree' | cut -d' ' -f2- | while read worktree_path; do
  if [ "$worktree_path" != "$repo_root" ] && [ "$worktree_path" != "$(dirname "$repo_root")/$(basename "$repo_root")" ]; then
    local branch=$(git -C "$worktree_path" branch --show-current 2>/dev/null)
    if [ -n "$branch" ]; then
      local pr_state=$(gh pr view "$branch" --json state -q '.state' 2>/dev/null || echo "")
      case "$pr_state" in
        "MERGED") echo "Merged: $branch"; echo "$worktree_path:$branch" >> "$temp_file" ;;
        "CLOSED") echo "Closed: $branch"; echo "$worktree_path:$branch" >> "$temp_file" ;;
        "OPEN") echo "Active: $branch" ;;
        "") echo "No PR: $branch" ;;
      esac
    fi
  fi
done

if [ ! -s "$temp_file" ]; then
  echo "\nNo merged/closed PRs found."
  rm -f "$temp_file"
  return 0
fi

echo "\nRemovable worktrees:"
while IFS=: read -r worktree_path branch; do
  echo "  $branch"
  cleanup_candidates+=("$worktree_path:$branch")
done < "$temp_file"

echo -n "\nRemove these? (y/N): "
read response
if [[ "$response" =~ ^[Yy]$ ]]; then
  while IFS=: read -r worktree_path branch; do
    echo "Removing $branch..."
    git worktree remove "$worktree_path" --force
  done < "$temp_file"
  echo "\nDone."
else
  echo "Cancelled."
fi

rm -f "$temp_file"
