# jj workspace helper - clones a repo for workspace-based workflow
# Usage: jjclone <url> [name]
if [ -z "$1" ]; then
  echo "Usage: jjclone <url> [name]"
  echo "Clones a repo with jj for workspace workflow"
  return 1
fi

local url="$1"
local name="$2"

# Extract repo name from URL if not provided
if [ -z "$name" ]; then
  name=$(basename "$url" .git)
fi

local target_dir="${name}.jj"

if [ -d "$target_dir" ]; then
  echo "Directory $target_dir already exists"
  return 1
fi

echo "Cloning with jj..."
if ! jj git clone "$url" "$target_dir"; then
  echo "Failed to clone repository"
  return 1
fi

cd "$target_dir"

echo "Creating main workspace..."
jj workspace add "./main"

echo "Cleaning up root (moving to workspace-only)..."
# Forget default workspace, keep only 'main'
jj workspace forget default 2>/dev/null || jj workspace forget "$(basename "$target_dir")" 2>/dev/null || true

# Remove working copy files from root, keep .jj and .git
find . -maxdepth 1 ! -name '.' ! -name '.jj' ! -name '.git' ! -name 'main' -exec rm -rf {} +

cd main

# Install dependencies
[ -f ".gitmodules" ] && echo "Updating submodules..." && git submodule update --init --recursive
[ -f "pnpm-lock.yaml" ] && echo "Running pnpm install..." && pnpm install
[ -f "bun.lockb" ] || [ -f "bun.lock" ] && echo "Running bun install..." && bun install
[ -f "Cargo.toml" ] && (grep -q "^\[workspace\]" "Cargo.toml" || [ -d "crates" ]) && echo "Running cargo check..." && cargo check

echo "\nCloned to: $(pwd)"
echo "Use 'jjcreate <name>' to create new workspaces"
