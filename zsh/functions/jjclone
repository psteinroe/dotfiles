# jj workspace helper - clones a repo with bare git backend
# Usage: jjclone <url> [name]
if [ -z "$1" ]; then
  echo "Usage: jjclone <url> [name]"
  echo "Clones a repo with bare git backend. No files in root, only workspaces."
  return 1
fi

local url="$1"
local name="$2"

# Extract repo name from URL if not provided
if [ -z "$name" ]; then
  name=$(basename "$url" .git)
fi

local target_dir="${name}.jj"

if [ -d "$target_dir" ]; then
  echo "Directory $target_dir already exists"
  return 1
fi

echo "Cloning with jj..."
if ! jj git clone --no-colocate "$url" "$target_dir"; then
  echo "Failed to clone repository"
  rm -rf "$target_dir"
  return 1
fi

echo "Creating main workspace..."
cd "$target_dir"
jj workspace add main -r "trunk()"
jj workspace forget default

# Remove working copy files from root (keep only .jj and main)
find . -maxdepth 1 ! -name '.' ! -name '.jj' ! -name 'main' -exec rm -rf {} +

cd main

# Install dependencies
[ -f ".gitmodules" ] && echo "Updating submodules..." && git submodule update --init --recursive
[ -f "pnpm-lock.yaml" ] && echo "Running pnpm install..." && pnpm install
[ -f "bun.lockb" ] || [ -f "bun.lock" ] && echo "Running bun install..." && bun install
[ -f "Cargo.toml" ] && (grep -q "^\[workspace\]" "Cargo.toml" || [ -d "crates" ]) && echo "Running cargo check..." && cargo check

echo "\nCloned to: $(pwd)"
echo "Use 'jjcreate <name>' for additional workspaces"
